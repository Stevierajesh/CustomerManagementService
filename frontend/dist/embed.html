<!DOCTYPE html>
<head>
    <title>the booking embed</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Molle&display=swap" rel="stylesheet">

    <!-- Global Styling -->
    <style>
        :root {
            --accent: rgb(0, 162, 255);
        }

        body,
        .embedWrapper {
            margin: 0;
            padding: 0;
            position: absolute;
            inset: 0;
        }

        .embedWrapper {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: 100%;
        }

        .rightPanelWrapper {
            position: relative;
            width: 100%;
        }

        #loginHamburger {
            position: absolute;
            top: 0;
            left: 0;
            width: 9%;
            aspect-ratio: 1;
            background-color: black;
            border-radius: 0 0 35% 0;
            cursor: pointer;
            z-index: 3;
        }

        #loginHamburger::before {
            content: '';
            position: absolute;
            inset: 5%;
            background-color: white;
            mask: url(./media/person-svgrepo-com.svg) no-repeat center / contain;
        }

        #leftPanelWrapper {
            background-color: rgb(20, 21, 22);
            display: flex;
            flex-flow: column nowrap;
            align-items: center;
            justify-content: center;
            width: 50%;
            height: 100%;
            position: relative;
            transition: width 0.7s;
            overflow: hidden;
        }

        #leftPanelWrapper.minimize {
            width: 0;
        }

        .profilePfpWrapper {
            width: 70%;
            margin-top: 8%;
        }

        .profilePfp {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            outline: 5px solid white;
            transition: transform 0.05s linear;
        }

        #loginForm {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            width: 60%;
        }

        #loginForm * {
            margin-bottom: 5px;
        }
    </style>


    <!-- Calendar -->
    <style>
        .bookingInvitation {
            text-align: center;
        }

        .calendarWrapper {
            position: absolute;
            bottom: 1px;
            width: 100%;
            height: 60%;
            overflow: hidden;
            font-family: 'Molle', serif;
            user-select: none;
        }

        .calendarWrapper .title {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 20%;
            font-size: 28px;
            text-align: center;
            margin: 0;
        }

        .calendarWrapper .title p {
            margin: 0 30px;
        }

        @keyframes slideLeft {
            from {
                transform: translate(0, 0);
            }
            to {
                transform: translate(5px, 500px);
            }
        }

        .dayWrapper {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            display: flex;
            flex-wrap: wrap;
            color: rgb(247, 254, 255);
        }

        .day {
            box-sizing: border-box;
            width: calc(100% / 6);
            font-size: 5em;
            text-align: center;
            background-color: rgb(174, 184, 183);
            outline: 1px solid black;
            animation: slideLeft 1s;
            position:relative;
            display:flex;
            justify-content: center;
            align-items: center;
        }

        .day:nth-of-type(7n-1),
        .day:nth-of-type(7n) {
            width: calc(100% / 12);
        }

        .day p {
            margin: 0;
            font-size: 1.8rem;
            z-index:3;
            position:absolute;
        }

        @keyframes hover_scale {
            from {
                transform: scale(1);
                z-index:2
            }
            to {
                transform: scale(1.2);
                z-index:2;
            }
        }

        @keyframes hover_descale {
            from {
                transform: scale(1.2);
            }
            to {
                transform: scale(1);
            }
        }

        .day:hover {
            background-color: var(--accent);
            /* animation: hover_scale 0.4s forwards; */
            cursor: pointer;
        }

        /* .day:not(:hover) {
            animation: hover_descale 0.2s;
        } */

        .day.notMonth {
            background-color: rgb(156, 162, 167);
        }

        .day.notMonth:hover {
            background-color: rgb(129, 182, 223);
        }

        .day.booked {
            background-color: rgb(37, 27, 49);
        }

        .day.booked:hover {
            background-color: rgb(56, 50, 70);
        }

        .slanted-char {
            position: relative;
            top: 1px;
            right: 2px;
        }

        .calButton:hover svg #backgroundCircle circle {
            fill: var(--accent) !important;
        }

        .bookingBlock {
            height:100%;
            background-color:red;
            position:absolute;
            outline:solid black 1px;
            opacity:0.4;
        }

        #bookingDayWrapper {
            display:flex;
            flex-direction:row;

            justify-content:space-between;
            align-items: center;

            position:absolute;
            width:100%;
            bottom:0px;
            top:0px;

            overflow:hidden

        }

        .bookingDay {
            position:relative;
            aspect-ratio:1;

            display:flex;
            align-items: center;

            width:40%;
            height:0px;

            transition:width .5s ease;
        }

        .bookingDay::before {
            content: '';
            aspect-ratio:1;
            position:absolute;
            width:100%;
        }

        .bookingDay:nth-child(1),
        .bookingDay:nth-child(3) {
            width: 30%;
        }

        .bookingDay:nth-child(2) {
            margin: 0px 5%;
        }

        .bookingDay:nth-child(1)::before {
            background-color:red;
        }

        .bookingDay:nth-child(2)::before {
            background-color:lime;
        }

        .bookingDay:nth-child(3)::before {
            background-color: blue;
        }
    </style>

    <!-- Booking -->
    <style>

    </style>
</head>
<body>
    <div class="embedWrapper">
        <div id="leftPanelWrapper">
            <div class="profilePfpWrapper">
                <div class="profilePfp" style="
                    background-color:white;
                    mask: url(./media/icon.webp) no-repeat center / contain;
                    "></div>
            </div>
            <form id="loginForm">
                <input type="text">
                <input type="text">
                <input type="submit">
            </form>
    
        </div>
        <div class="rightPanelWrapper">
            
            <div id="loginHamburger" data="false" onclick="toggleHamburgerMenu()"></div>
            
            <div class="bookingInvitation">
                <h1>So why not book an appointment!</h1>
                <h2>It's easy to do, and we'll make your car look brand new</h2>
            </div>
            
            <div class="calendarWrapper">
                <div class="title">
                    <div onclick="changeMonth(-1)" class="calButton" style="transform:scale(-1, 1)"></div>
                    <p id="month">...</p>
                    <div onclick="changeMonth(1)" class="calButton"></div>
                </div>
                <div class="dayWrapper" id="calendar"></div>
            </div>
            <div style="visibility:hidden">
            <!-- For Testing, Make Calendar Block Hidden -->
            
                <div id="bookingDayWrapper" onclick="rotateCarousel()">
                
                <div class="bookingDay"></div>
                <div class="bookingDay"></div>
                <div class="bookingDay"></div>
                
            </div>
            
            <div>
                
            </div>
            </div>
        </div>
    </div>

    <script>

    function rotateCarousel() {
        const bookingDays = document.getElementById('bookingDayWrapper').children;
        const length = bookingDays.length;

        for (let i = 0; i < length; i++) {
            const bookingDay = bookingDays[i];
            // Ensure order is an integer
            const order = parseInt(window.getComputedStyle(bookingDay).order) || i;
            bookingDay.style.order = (order + 1) % length;
        }
    }

    
    // Handles toggling of the hamburger menu
    function toggleHamburgerMenu(forceState = null) {
        const burger = document.getElementById('loginHamburger');
        const panel = document.getElementById('leftPanelWrapper');

        // Ensure dataset property exists
        // if (!panel.dataset.minimized) {
        //     panel.dataset.minimized = "true";
        // }

        const isMinimized = forceState !== null ? forceState : panel.dataset.minimized === "true";

        panel.classList.toggle('minimize', !isMinimized);
        panel.dataset.minimized = (!isMinimized).toString();
    }

    // Utility function to get the last day of a specific month and year
    function getLastDayOfMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    // Generates an ID for a calendar day element
    function generateDayId(year, month, day) {
        return `day-${year}-${month}-${day}`;
    }

    // Determines previous or next year and month based on offset
    function getAdjustedYearMonth(year, month, offset) {
        const newMonth = month + offset;
        const adjustedYear = year + Math.floor(newMonth / 12);
        const adjustedMonth = (newMonth % 12 + 12) % 12; // Ensures positive month values
        return { year: adjustedYear, month: adjustedMonth };
    }

    // Updates the selected month and refreshes the calendar
    function changeMonth(offset) {
        selectedDate.setMonth(selectedDate.getMonth() + offset);
        populateCalendar();
    }

    // Fetches and applies SVG icons to calendar buttons
    function loadSVGIcons() {
        fetch('./media/calArrow.svg')
            .then(response => response.text())
            .then(svgContent => {
                document.querySelectorAll('.calButton').forEach(button => {
                    button.innerHTML = svgContent;
                });
            })
            .catch(err => console.error('Failed to load SVG:', err));
    }

    // Handles day click events
    function handleDayClick(day) {
        alert(`Selected day: ${day}`);
    }

    // Creates and appends a day element to the calendar
    function addDayElement(day, year, month, extraClasses = '') {
        const calendar = document.getElementById('calendar');
        const dayId = generateDayId(year, month, day);

        const dayElement = document.createElement('div');
        dayElement.className = `day${extraClasses ? ` ${extraClasses}` : ''}`;
        dayElement.id = dayId;
        dayElement.innerHTML = `<p>${day}</p>`;
        dayElement.onclick = () => handleDayClick(day);

        calendar.appendChild(dayElement);
    }

    // Marks booked days on the calendar
    function highlightBookedDays(availability) {
        availability.forEach(({ start, end }) => {
            const startDate = new Date(start);
            const endDate = new Date(end);

            while (startDate <= endDate) {
                const dayId = generateDayId(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const dayElement = document.getElementById(dayId);
                if (dayElement) {
                    dayElement.classList.add('booked');
                }
                startDate.setDate(startDate.getDate() + 1);
            }
        });
    }

    function addBookedTimeBlock(dayElement, startTime, endTime) {
        const bookingBlock = document.createElement('div');
        bookingBlock.className = 'bookingBlock';
        const offset = 100 * (startTime / 24);
        const length = 100 * ( (endTime - startTime) / 24);

        bookingBlock.style.left = `${offset}%`
        bookingBlock.style.width = `${length}%`

        const textElement = dayElement.querySelector('p')
        dayElement.insertBefore(bookingBlock, textElement)
    }

    // Populates the calendar based on the selected date
    function populateCalendar() {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        const monthLabel = document.getElementById('month');
        monthLabel.textContent = selectedDate.toLocaleString('default', { month: 'long' });

        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = getLastDayOfMonth(year, month);

        const firstDayOffset = (firstDayOfMonth.getDay() + 6) % 7;
        const lastDayPrevMonth = getLastDayOfMonth(year, month - 1);

        /* TESTING BLOCK, DELETE FOR RELEASE */
        
        // addDayElement(42, 2025, 12)
        // const testingDay = document.getElementById(generateDayId(2025, 12, 42))
        // addBookedTimeBlock(testingDay, 8, 12)
        // addBookedTimeBlock(testingDay, 2, 4)
        // addBookedTimeBlock(testingDay, 14, 19)
        /*-----------------------------------*/

        // Previous month days
        const { year: prevYear, month: prevMonth } = getAdjustedYearMonth(year, month, -1);
        for (let i = lastDayPrevMonth - firstDayOffset + 1; i <= lastDayPrevMonth; i++) {
            addDayElement(i, prevYear, prevMonth, 'notMonth');
        }

        // Current month days
        for (let i = 1; i <= lastDayOfMonth; i++) {
            addDayElement(i, year, month);
        }

        // Next month days
        const { year: nextYear, month: nextMonth } = getAdjustedYearMonth(year, month, 1);
        const remainingDays = (7 - (firstDayOffset + lastDayOfMonth) % 7) % 7;
        for (let i = 1; i <= remainingDays; i++) {
            addDayElement(i, nextYear, nextMonth, 'notMonth');
        }

        highlightBookedDays(
            transformResponse(
                availabilityResponse
            )
        );
    }

    function transformResponse(input) {
        const output = []
        const addTime = (date, replace) => {
            if (date.includes('T')) {return date}
            date += `T${replace}-05:00`
            return date
        }
        input.forEach(event => {
            const {start, end} = event;
            output.push(
                {
                    start: addTime(start, '00:00'),
                    end: addTime(end, '23:59')
                }
            )
            
        })
        return output
    }

    
    // Initialization
    const availabilityResponse = [
        { start: '2024-12-09', end: '2024-12-10' },
        { start: '2024-12-10', end: '2024-12-14' },
        { start: '2024-12-19', end: '2024-12-20' },
        { start: '2024-12-31T10:00:00-05:00', end: '2024-12-31T14:00:00-05:00' },
    ];
    
    transformResponse(availabilityResponse)

    
    let selectedDate = new Date(2024, 11, 16);

    populateCalendar();
    loadSVGIcons();


    
    </script>
    
</body>