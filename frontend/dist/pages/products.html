<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Services</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .services-container {
      width: 95%;
      margin: 20px auto;
      padding: 20px;
      background-color: #2b2929;
      border-radius: 10px;
      text-align: center;
      height: 500px;
      overflow-y: auto;
      position: relative;
    }

    .services-container h1 {
  color: white;
  font-size: 2em;
  margin: 0;
  position: sticky; /* Make the header fixed within the container */
  top: 0; /* Align it to the top of the container */
  background-color: #2b2929; /* Match container background to avoid overlay issues */
  z-index: 1; /* Ensure it stays above scrolling content */
  padding: 10px 0;
}

    .service-box {
      width: 90%;
      height: 50px;
      background-color: #645f5f;
      margin: 30px auto 10px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-size: 1.2em;
      transition: background-color 0.3s ease;
      padding: 0 10px;
      cursor: pointer;
    }

    .service-box:hover {
      background-color: #4a4848;
    }

    .selected {
      background-color: #3a3a3a !important;
    }

    .more-info-btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .more-info-btn:hover {
      background-color: #0056b3;
    }

    .add-service-btn, .delete-service-btn {
      padding: 10px 20px;
      font-size: 1em;
      margin: 10px;
    }

    .add-service-btn:hover {
      background-color: #ddd;
    }

    .delete-service-btn {
      background-color: darkred;
      color: white;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .delete-service-btn.active {
      background-color: red;
      cursor: pointer;
      opacity: 1;
    }

    .delete-service-btn:hover {
      color: red;
      background-color: rgb(255, 0, 0);
    }

    /* Specific styles for the delete confirmation modal */
#deleteConfirmationModal .modal-header {
  background-color: #ffcccb;
  color: darkred;
  font-weight: bold;
  font-size: 1.5em;
  padding: 10px;
  border-bottom: 1px solid darkred;
}

#deleteConfirmationModal .modal-body {
  padding: 20px;
  text-align: center;
}

#deleteConfirmationModal .modal-body p {
  color: #333;
  font-size: 1.2em;
  margin-bottom: 15px;
}

#deleteServiceNameInput {
  width: 90%;
  padding: 10px;
  font-size: 1em;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 5px;
}

#deleteConfirmationModal .modal-footer {
  display: flex;
  justify-content: space-between;
  padding: 10px 20px;
}

#deleteForeverBtn {
  background-color: darkred;
  color: white;
  padding: 10px 20px;
  font-size: 1em;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

#deleteForeverBtn:hover {
  background-color: red;
}

#cancelDeleteBtn {
  background-color: #ccc;
  color: black;
  padding: 10px 20px;
  font-size: 1em;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

#cancelDeleteBtn:hover {
  background-color: #aaa;
}


    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      padding: 30px;
      text-align: center;
    }

    .modal.active, .modal-overlay.active {
      display: block;
    }

    .modal-header {
      font-size: 1.5em;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header .close-btn {
      background-color: red;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      font-size: 1.2em;
      cursor: pointer;
      text-align: center;
      line-height: 40px;
      border-radius: 5px;
    }

    .modal input,
    .modal textarea {
      width: 90%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .modal textarea {
      height: 100px;
      resize: none;
    }

    .modal button {
      padding: 10px 20px;
      font-size: 1em;
      margin: 10px;
      cursor: pointer;
    }

    .modal .add-btn {
      background-color: green;
      color: white;
    }

    select {
      width: 90%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <ul class="nav-links">
      <li><a href="login.html" class="exit-link" style="color: red;">Exit</a></li>
      <li><a href="dashboard.html">Main</a></li>
      <li><a href="finances.html">Finances</a></li>
      <li><a href="crm.html">CRM</a></li>
      <li><a href="accounts.html">Account</a></li>
      <li><a href="products.html">Products</a></li>
    </ul>
  </nav>

  <div class="services-container" id="servicesContainer">
    <h1>Services</h1>
    <div class="services-list">
      <!-- Services will be populated here -->
    </div>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button class="add-service-btn">Add a Service</button>
    <button class="delete-service-btn" id="deleteServiceBtn" disabled>Delete a Service</button>
  </div>

  <div class="modal-overlay" id="modalOverlay"></div>

  <div class="modal" id="addServiceModal">
    <div class="modal-header">
      <span>Add New Service</span>
      <button class="close-btn" id="closeModalBtn">&times;</button>
    </div>
    <input type="text" id="serviceCategory" placeholder="Service Category">
    <input type="number" id="servicePrice" placeholder="Service Price">
    <textarea id="serviceDescription" placeholder="Service Description"></textarea>
    <select id="serviceVisibility">
      <option value="Public">Public</option>
      <option value="Private">Private</option>
    </select>
    <button class="add-btn" id="saveServiceBtn">Add</button>
  </div>

  <!-- Delete Confirmation Modal -->
<div class="modal" id="deleteConfirmationModal">
  <div class="modal-header">
    <span>Confirm Deletion</span>
    <button class="close-btn" id="closeDeleteModalBtn">&times;</button>
  </div>
  <div class="modal-body">
    <p>
      Are you sure you want to delete this service? This action cannot be undone.
    </p>
    <input
      type="text"
      id="deleteServiceNameInput"
      placeholder="Enter the service name to confirm"
    />
  </div>
  <div class="modal-footer">
    <button class="add-btn" id="deleteForeverBtn">Delete Forever</button>
    <button class="add-btn" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>


  <div id="error-notifications-container"></div>
  <script src="../js/system.bundle.js" type="module"></script>
  <script src="../js/auth.bundle.js" type="module"></script>

  <script>
async function fetchServiceItems() {
  try {
    const response = await fetch('http://localhost:7777/services');
    if (!response.ok) {
      throw new Error('Failed to fetch services items');
    }

    const items = await response.json();
    const servicesContainer = document.querySelector('.services-list');
    servicesContainer.innerHTML = '';

    items.forEach(item => {
      const serviceDiv = document.createElement('div');
      serviceDiv.className = 'service-box';
      serviceDiv.innerHTML = `
        <span>${item.ServiceCategory} - $${item.ServicePrice} (${item.Description})</span>
        <button class="more-info-btn">More Info</button>
      `;
      serviceDiv.dataset.serviceName = item.ServiceCategory;

      serviceDiv.addEventListener('click', (event) => {
        event.stopPropagation(); // Prevent deselection from container click
        document.querySelectorAll('.service-box').forEach(box => box.classList.remove('selected'));
        serviceDiv.classList.add('selected');

        selectedService = item.ServiceCategory;
        deleteServiceBtn.classList.add('active');
        deleteServiceBtn.disabled = false;
      });

      servicesContainer.appendChild(serviceDiv);
    });
  } catch (error) {
    console.error('Error fetching services items:', error);
  }
}

window.onload = fetchServiceItems;

const addServiceBtn = document.querySelector('.add-service-btn');
const addServiceModal = document.getElementById('addServiceModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const modalOverlay = document.getElementById('modalOverlay');
const saveServiceBtn = document.getElementById('saveServiceBtn');
const servicesList = document.querySelector('.services-list');
const deleteServiceBtn = document.getElementById('deleteServiceBtn');
const servicesContainer = document.getElementById('servicesContainer');

// Delete confirmation modal elements
const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
const deleteForeverBtn = document.getElementById('deleteForeverBtn');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const deleteServiceNameInput = document.getElementById('deleteServiceNameInput');

let selectedService = null;

addServiceBtn.addEventListener('click', () => {
  addServiceModal.classList.add('active');
  modalOverlay.classList.add('active');
});

closeModalBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', closeModal);

function closeModal() {
  addServiceModal.classList.remove('active');
  modalOverlay.classList.remove('active');
}

saveServiceBtn.addEventListener('click', async () => {
  const category = document.getElementById('serviceCategory').value;
  const price = document.getElementById('servicePrice').value;
  const description = document.getElementById('serviceDescription').value;
  const visibility = document.getElementById('serviceVisibility').value;

  if (category && price && description) {
    const newService = {
      ServiceCategory: category,
      ServicePrice: parseFloat(price),
      Description: description,
      Visibility: visibility,
    };

    try {
      const response = await fetch('http://localhost:7777/services', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newService),
      });

      if (!response.ok) throw new Error('Failed to add service');

      fetchServiceItems();

      document.getElementById('serviceCategory').value = '';
      document.getElementById('servicePrice').value = '';
      document.getElementById('serviceDescription').value = '';
      document.getElementById('serviceVisibility').value = 'Public';

      closeModal();
    } catch (error) {
      console.error('Error adding service:', error);
    }
  } else {
    console.error('Please fill in all fields');
  }
});

// Open delete confirmation modal
deleteServiceBtn.addEventListener('click', () => {
  if (!selectedService) {
    console.log('No service selected to delete.');
    return;
  }
  deleteServiceNameInput.value = ''; // Clear the input field
  modalOverlay.classList.add('active');
  deleteConfirmationModal.classList.add('active');
});

// Close delete confirmation modal
closeDeleteModalBtn.addEventListener('click', closeDeleteConfirmationModal);
cancelDeleteBtn.addEventListener('click', closeDeleteConfirmationModal);

function closeDeleteConfirmationModal() {
  modalOverlay.classList.remove('active');
  deleteConfirmationModal.classList.remove('active');
}

// Handle delete forever action
deleteForeverBtn.addEventListener('click', async () => {
  const inputName = deleteServiceNameInput.value.trim();

  if (inputName !== selectedService) {
    console.error('The entered service name does not match. Please try again.');
    return;
  }

  try {
    const response = await fetch('http://localhost:7777/services', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ServiceCategory: selectedService }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to delete service');
    }

    console.log(`Service "${selectedService}" has been deleted.`);
    fetchServiceItems();
    closeDeleteConfirmationModal();
    deleteServiceBtn.classList.remove('active');
    deleteServiceBtn.disabled = true;
    selectedService = null;
  } catch (error) {
    console.error('Error deleting service:', error);
    console.error(error.message);
  }
});

servicesContainer.addEventListener('click', () => {
  document.querySelectorAll('.service-box').forEach(box => box.classList.remove('selected'));
  selectedService = null;
  deleteServiceBtn.classList.remove('active');
  deleteServiceBtn.disabled = true;
});

  </script>
</body>
</html>
